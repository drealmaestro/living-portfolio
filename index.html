<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Living Portfolio â€” v2</title>
<style>
:root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e2e8f0;--g:#10b981;--y:#f59e0b;--r:#ef4444;--b:#38bdf8;--card:#111827;--chip:#0b2538;}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.wrapper{max-width:1200px;margin:auto;padding:16px}
.header{display:grid;gap:10px;grid-template-columns:1fr auto;align-items:center;margin-bottom:12px}
.h1{font-size:20px;font-weight:700}.sub{color:var(--muted);font-size:12px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.card{background:var(--panel);border:1px solid #0b2540;border-radius:14px;padding:12px;box-shadow:0 0 0 1px rgba(59,130,246,.06) inset}
.kpi{display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid #0b2540;border-radius:12px;padding:10px 12px}
.kpi strong{font-size:14px}.pill{padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid #0b2540;background:var(--chip)}
.pill.ok{color:#0ea5e9;border-color:#0ea5e9}.pill.warn{color:var(--y);border-color:var(--y)}.pill.danger{color:var(--r);border-color:var(--r)}
.search{display:flex;gap:8px;align-items:center}
input[type="search"]{width:260px;max-width:100%;background:#0b1b2c;border:1px solid #13314f;color:var(--text);padding:8px 10px;border-radius:10px}
button{background:#0b1b2c;border:1px solid #1b3a5a;color:#bae6fd;border-radius:10px;padding:8px 10px;cursor:pointer}button:hover{background:#0a1930}
.h2{font-size:14px;letter-spacing:.02em;text-transform:uppercase;color:#93c5fd;margin:4px 0 10px}
.section{display:grid;gap:10px}.grid{display:grid;gap:10px}
@media(min-width:960px){.grid{grid-template-columns:1.2fr .9fr .9fr}}
.table{width:100%;border-collapse:collapse}
.table th,.table td{font-size:12px;text-align:left;padding:6px;border-bottom:1px solid #0b2540;vertical-align:top}
.table th{color:#a5b4fc;font-weight:600}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1b2c;border:1px solid #1b3a5a;color:#7dd3fc;font-weight:600}
.tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;margin-right:4px}
.tag.g{background:rgba(16,185,129,.15);color:#34d399;border:1px solid rgba(16,185,129,.35)}
.tag.y{background:rgba(245,158,11,.15);color:#fbbf24;border:1px solid rgba(245,158,11,.35)}
.tag.r{background:rgba(239,68,68,.15);color:#f87171;border:1px solid rgba(239,68,68,.35)}
.small{font-size:11px;color:var(--muted)}
.group{border:1px dashed #123456;border-radius:12px;padding:8px;margin-bottom:8px}
.group h3{margin:0 0 6px;font-size:13px;color:#c7d2fe}
.timeline{display:grid;gap:6px;max-height:420px;overflow:auto}
.timeline .item{display:flex;gap:8px;align-items:center;background:#0b1b2c;border:1px solid #1b3a5a;border-radius:10px;padding:8px}
.footer{margin-top:10px;color:var(--muted);font-size:11px}
hr{border:0;border-top:1px solid #0b2540;margin:6px 0}
</style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div>
      <div class="h1">âš¡ Living Portfolio Dashboard â€” v2</div>
      <div class="sub">As-of <span id="asof">â€”</span> Â· Status <span id="statusPill" class="pill">Loadingâ€¦</span></div>
    </div>
    <div class="search">
      <input id="q" type="search" placeholder="Search tickerâ€¦ (e.g., NVDA)"/>
      <button id="btnRefresh">Refresh</button>
    </div>
  </div>

  <div class="row" id="topKPIs">
    <div class="kpi"><strong>Sector exposure</strong> <span id="kpiSectors" class="small">â€”</span></div>
    <div class="kpi"><strong>Spec sleeve</strong> <span id="kpiSpec" class="pill">â€”</span></div>
    <div class="kpi"><strong>Flow snapshot</strong> <span id="kpiFlow" class="small">â€”</span></div>
  </div>

  <div class="grid">
    <div class="section card" id="coreCol">
      <div class="h2">Core Portfolio (grouped by sector)</div>
      <div id="coreGroups"></div>
    </div>

    <div class="section card">
      <div class="h2">Swing Plays (3â€“6M)</div>
      <table class="table" id="swingTable">
        <thead><tr><th>Ticker</th><th>Weight</th><th>Signal</th><th>Q</th><th>Notes</th><th>Exit</th></tr></thead>
        <tbody></tbody>
      </table>
      <hr/>
      <div class="h2">Speculative Sleeve (Graduation Watch)</div>
      <table class="table" id="specTable">
        <thead><tr><th>Ticker</th><th>Weight</th><th>Signal</th><th>Q</th><th>Notes</th><th>Graduation</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section card">
      <div class="h2">Catalyst Timeline (Next 90 Days)</div>
      <div class="timeline" id="timeline"></div>
    </div>
  </div>

  <div class="footer">v2 UI Â· loads <code>live.json</code> Â· caches busted Â· mobile friendly Â· auto-refresh every 3 min</div>
</div>

<script>
(() => {
  const ENDPOINT = 'https://drealmaestro.github.io/living-portfolio/live.json';
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const asPct = x => { if(x==null) return 0; const s=String(x).trim(); if(s.endsWith('%')) return parseFloat(s); const n=parseFloat(s); return Number.isFinite(n)?n:0; };
  const groupBy = (a,k) => a.reduce((m,it)=>{const key=k(it)||'Other';(m[key]||(m[key]=[])).push(it);return m;}, {});
  const pad = n=>String(n).padStart(2,'0');
  const nowStr = ()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`};

  function setStatus(ok){ const pill=$('#statusPill'); pill.textContent = ok ? 'ðŸŸ¢ OK' : 'ðŸ”´ Check'; pill.className = 'pill '+(ok?'ok':'danger'); }

  function renderCore(list){
    const wrap = $('#coreGroups'); wrap.innerHTML='';
    const groups = groupBy(list, it => it.sector || (String(it.name||'').includes('ETF') ? 'ETFs' : 'Other'));
    Object.entries(groups).forEach(([sector,items])=>{
      const box = document.createElement('div'); box.className='group';
      box.innerHTML = `<h3>${sector}</h3>
        <table class="table"><thead><tr><th>Ticker</th><th>Name</th><th>Weight</th><th>Badge</th><th>Q</th><th>Notes</th><th>Exit</th></tr></thead>
        <tbody>${items.map(it=>`
          <tr>
            <td><span class="badge">${it.ticker}</span></td>
            <td>${it.name||''}</td>
            <td>${it.weight||''}</td>
            <td>${it.badge||''}</td>
            <td>${it.q!=null?`<span class="tag ${it.q>=9?'g':it.q>=6?'y':'r'}">Q ${it.q}</span>`:''}</td>
            <td>${it.notes||''}</td>
            <td class="small">${it.exits||''}</td>
          </tr>`).join('')}</tbody></table>`;
      wrap.appendChild(box);
    });
  }

  function renderRows(id, rows){
    const tb = $(id); tb.innerHTML = rows.map(r=>`
      <tr>
        <td><span class="badge">${r.ticker}</span></td>
        <td>${r.weight||''}</td>
        <td>${r.signal||''}</td>
        <td>${r.q!=null?`<span class="tag ${r.q>=9?'g':r.q>=6?'y':'r'}">${r.q}</span>`:''}</td>
        <td>${r.notes||''}</td>
        <td class="small">${r.exits||''}</td>
      </tr>`).join('');
  }

  function renderTimeline(cats){
    const el = $('#timeline');
    const list = [];
    (cats.company||[]).forEach(x=>list.push({date:x.date,label:`${x.ticker||''} ${x.ticker? 'â€” ':''}${x.label}`,color:x.color||'y',impact:x.impact||'Med'}));
    (cats.macro||[]).forEach(x=>list.push({date:x.date,label:x.label,color:x.color||'y',impact:x.impact||'Med'}));
    list.sort((a,b)=>String(a.date).localeCompare(String(b.date)));
    el.innerHTML = list.map(x=>`
      <div class="item">
        <span class="tag ${x.color}">${x.date||''}</span>
        <div>${x.label}</div>
        <span class="tag ${x.impact==='High'?'g':x.impact==='Med'?'y':'r'}">${x.impact}</span>
      </div>`).join('');
  }

  function computeKPIs(data){
    const sectors={}; (data.core||[]).forEach(it=>{const s=it.sector||'Other'; sectors[s]=(sectors[s]||0)+asPct(it.weight);});
    const top = Object.entries(sectors).sort((a,b)=>b[1]-a[1]).slice(0,4).map(([k,v])=>`${k} ${v.toFixed(0)}%`).join(' Â· ');
    $('#kpiSectors').textContent = top || 'â€”';

    const specPct = (data.spec||[]).reduce((s,x)=>s+asPct(x.weight),0);
    const pill = $('#kpiSpec'); pill.textContent = `${specPct.toFixed(1)}% of portfolio`;
    pill.className = 'pill ' + (specPct<=5?'ok':specPct<=7?'warn':'danger');

    const f=data.flow||{}; const bits=[];
    if(typeof f.vgt_heartbeat_outflow_usd_mm==='number') bits.push(`VGT outflow ${f.vgt_heartbeat_outflow_usd_mm}`);
    $('#kpiFlow').textContent = bits.join(' Â· ') || 'â€”';

    const tech = (sectors['Technology']||0);
    const ok = (tech<=30) && (specPct<=5);
    setStatus(ok);
  }

  function filterAll(q){
    q=(q||'').trim().toUpperCase();
    const show = el => { if(!el) return; el.style.display=''; };
    const hide = el => { if(!el) return; el.style.display='none'; };
    if(!q){ $$('.group tr, #swingTable tbody tr, #specTable tbody tr, #timeline .item').forEach(show); return; }
    const match = tr => (tr.textContent||'').toUpperCase().includes(q);
    $$('.group tr').forEach(tr=> match(tr)?show(tr):hide(tr));
    $$('#swingTable tbody tr').forEach(tr=> match(tr)?show(tr):hide(tr));
    $$('#specTable tbody tr').forEach(tr=> match(tr)?show(tr):hide(tr));
    $$('#timeline .item').forEach(div=> (div.textContent||'').toUpperCase().includes(q)?show(div):hide(div));
  }

  function render(data){
    $('#asof').textContent = nowStr();
    renderCore(data.core||[]);
    renderRows('#swingTable tbody', data.swing||[]);
    renderRows('#specTable tbody', data.spec||[]);
    renderTimeline(data.catalysts||{company:[],macro:[]});
    computeKPIs(data);
  }

  async function load(){
    try{
      const url = ENDPOINT + (ENDPOINT.includes('?')?'&':'?') + 'cb=' + Date.now();
      const r = await fetch(url, {cache:'no-store'}); const j = await r.json(); render(j);
    }catch(e){ console.warn('Fetch fail', e); setStatus(false); }
  }

  $('#q').addEventListener('input', e=>filterAll(e.target.value));
  $('#btnRefresh').addEventListener('click', load);

  load(); setInterval(load, 180000);
})();
</script>
</body>
</html>