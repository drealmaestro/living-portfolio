<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Living Portfolio â€” Unified Dashboard</title>
<style>
body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #0a0f1c; color: #f1f5f9; }
.wrapper { max-width: 1200px; margin: auto; padding: 1rem; }
.card { background: #111827; margin-bottom: 1rem; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
h1,h2,h3 { margin: 0 0 .5rem 0; color: #f9fafb; }
.table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
.table th, .table td { padding: .5rem; border-bottom: 1px solid #374151; text-align: left; }
.badge { display:inline-block; padding:2px 6px; background:#1e293b; border-radius:4px; font-weight:bold; }
.tag { display:inline-block; padding:2px 6px; border-radius:4px; font-size:.75rem; }
.tag.g { background:#064e3b; color:#10b981; }
.tag.y { background:#78350f; color:#fbbf24; }
.tag.r { background:#7f1d1d; color:#f87171; }
.small { font-size:.875rem; color:#94a3b8; }
.note { background:#1e293b; padding:.5rem; border-radius:.5rem; margin-top:.5rem; }
.heat { display:grid; grid-template-columns: repeat(2,1fr); gap:.5rem; }
.cell { background:#1f2937; padding:.5rem; border-radius:.5rem; }
</style>
</head>
<body>
<div class="wrapper">
  <!-- HEADER -->
  <div class="card">
    <h1>Living Portfolio â€” Unified Dashboard</h1>
    <div class="small">Status: <span id="compliancePill" class="tag y">CHECKINGâ€¦</span> Â· Last update <span id="asof">â€”</span></div>
  </div>

  <!-- CORE LONG-TERM -->
  <div class="card">
    <h2>Core â€” Long-term (ðŸŸ¢ Compounding Engine)</h2>
    <table class="table" id="coreLTTable">
      <thead><tr><th>Ticker</th><th>Name</th><th>Sector</th><th>Weight</th><th>Badge</th><th>Q</th><th>Notes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- CORE SWING -->
  <div class="card">
    <h2>Core â€” Swing (3â€“6M)</h2>
    <table class="table" id="coreSwingTable">
      <thead><tr><th>Ticker</th><th>Name</th><th>Weight</th><th>Signal</th><th>Q</th><th>Notes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- SPEC SLEEVE -->
  <div class="card">
    <h2>Speculative Sleeve (â‰¤5%)</h2>
    <table class="table" id="specTable">
      <thead><tr><th>Ticker</th><th>Name</th><th>Weight</th><th>Notes</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- FLOW & MICROSTRUCTURE -->
  <div class="card">
    <h2>Flow & Microstructure</h2>
    <ul class="small">
      <li><b>BTC/ETH ETF net flows (5d)</b>: <span class="tag y" id="flowEtf">n/a</span></li>
      <li><b>Perp basis</b>: <span class="tag y" id="flowBasis">n/a</span> Â· <b>Open Interest</b>: <span class="tag y" id="flowOI">n/a</span></li>
      <li><b>Options skew</b>: <span class="tag y" id="flowSkew">n/a</span> Â· <b>IV Rank</b>: <span class="tag y" id="flowIV">n/a</span></li>
      <li><b>Off-exchange % volume</b>: <span class="tag y" id="flowOffEx">n/a</span></li>
    </ul>
  </div>

  <!-- BLIND-SPOT STRIP -->
  <div class="card" id="blindspotPanel">
    <h2>Blind-Spot Strip</h2>
    <div class="heat" id="blindTiles">
      <div class="cell"><b>Web Traffic</b><span id="tileWeb">n/a</span></div>
      <div class="cell"><b>Job Posts</b><span id="tileJobs">n/a</span></div>
      <div class="cell"><b>App Rank</b><span id="tileApp">n/a</span></div>
      <div class="cell"><b>Dark Pool Proxy</b><span id="tileDP">n/a</span></div>
    </div>
  </div>

  <!-- CATALYST TIMELINE + IR VERIFIER -->
  <div class="card">
    <h2>Catalyst Timeline</h2>
    <div class="lanes">
      <div>
        <h3>Company Catalysts</h3>
        <ul id="catalystsCompany"></ul>
      </div>
      <div>
        <h3>Macro Catalysts</h3>
        <ul id="catalystsMacro"></ul>
      </div>
    </div>
    <div class="note small" style="margin-top:8px">
      <b>IR Verifier:</b> <span id="verifyStatus">Not configured</span>
    </div>
  </div>
</div>

<script>
(function(){
  const now=new Date();const pad=n=>String(n).padStart(2,'0');
  document.getElementById('asof').textContent=
    now.getFullYear()+"-"+pad(now.getMonth()+1)+"-"+pad(now.getDate())+" "+pad(now.getHours())+":"+pad(now.getMinutes());
  const techInclEtfs=28; const crypto=10; const spec=5; const buffer=5; const singleTier3_NVDA=2;
  const ok=(techInclEtfs<=30)&&(crypto<=15)&&(spec<=5)&&(buffer>=5)&&(singleTier3_NVDA<=2);
  const pill=document.getElementById('compliancePill');
  pill.textContent= ok? 'COMPLIANT':'BREACH';
  pill.style.background= ok? '#0ea5e9':'#ef4444';
})();

// ===== LIVE DATA =====
window.LPE_DATA_ENDPOINT = "https://drealmaestro.github.io/living-portfolio/live.json";
window.LPE_IR_VERIFY_ENDPOINT = "https://drealmaestro.github.io/living-portfolio/ir-verify.json";

(function(){
  const endpoint = window.LPE_DATA_ENDPOINT; if(!endpoint) return;
  const bust = ()=>'&cb='+(Date.now());
  let lastHash = null;
  const tick = ()=>{
    fetch(endpoint + (endpoint.includes('?')?'&':'?')+bust(), {cache:'no-store'})
      .then(r=>r.json())
      .then(data=>{
        if(!data) return;
        if(data.hash && data.hash===lastHash) return;
        lastHash = data.hash || Math.random().toString(36).slice(2);
        renderCore(data.core||[]);
        renderSwing(data.swing||[]);
        renderSpec(data.spec||[]);
        renderCatalysts(data.catalysts||{company:[],macro:[]});
        renderFlow(data.flow||null);
        renderBlindspots(data.blindspots||null);
      })
      .catch(()=>{});
  };
  tick(); setInterval(tick, 180000);

  function formatQ(q){ if(q==null) return ''; const n=Number(q); if(Number.isNaN(n)) return q; const cls = n>=9?'g':(n>=6?'y':'r'); return `<span class="tag ${cls}">${n}</span>`; }
  function td(x){return `<td>${x??''}</td>`}
  function renderCore(rows){
    const body=document.getElementById('coreLTTable').querySelector('tbody');
    body.innerHTML = rows.map(r=>`<tr><td><span class="badge">${r.ticker}</span></td>${td(r.name)}${td(r.sector)}${td(r.weight)}${td(r.badge||'ðŸŸ¢ Engine')}${td(formatQ(r.q))}${td(r.notes||'')}</tr>`).join('');
  }
  function renderSwing(rows){
    const body=document.getElementById('coreSwingTable').querySelector('tbody');
    body.innerHTML = rows.map(r=>`<tr><td><span class="badge">${r.ticker}</span></td>${td(r.name)}${td(r.weight)}${td(r.signal||'')}${td(formatQ(r.q))}${td(r.notes||'')}</tr>`).join('');
  }
  function renderSpec(rows){
    const body=document.getElementById('specTable').querySelector('tbody');
    body.innerHTML = rows.map(r=>`<tr><td><span class="badge">${r.ticker}</span></td>${td(r.name)}${td(r.weight)}${td(r.notes||'')}</tr>`).join('');
  }
  function renderCatalysts(c){
    const cUL=document.getElementById('catalystsCompany');
    const mUL=document.getElementById('catalystsMacro');
    if(cUL){ cUL.innerHTML = (c.company||[]).map(x=>`<li><b>${x.date}</b> â€” <b>${x.ticker}</b> ${x.label} <span class="tag ${x.color||'y'}">${x.impact||'Watch'}</span></li>`).join(''); }
    if(mUL){ mUL.innerHTML = (c.macro||[]).map(x=>`<li><b>${x.date||x.label}</b> â€” ${x.label||''} <span class="tag ${x.color||'y'}">${x.impact||'Med'}</span></li>`).join(''); }
  }
  function renderFlow(flow){
    if(!flow) return;
    const set=(id,txt,cls)=>{const el=document.getElementById(id); if(!el) return; el.textContent=txt; el.className='tag '+(cls||'y');};
    const color=(v,th)=> v>=th.g? 'g' : v<=th.r? 'r' : 'y';
    if(flow.etf5d!=null) set('flowEtf', (flow.etf5d>0?'+':'')+flow.etf5d+" (5d)", color(flow.etf5d,{g:0,r:-0.1}));
    if(flow.basis!=null) set('flowBasis', flow.basis+"%", color(flow.basis,{g:8,r:0}));
    if(flow.oiChg!=null) set('flowOI', (flow.oiChg>0?'+':'')+flow.oiChg+'%', color(flow.oiChg,{g:2,r:-2}));
    if(flow.skew!=null) set('flowSkew', flow.skew, (flow.skew==="calls>puts"? 'g': (flow.skew==="puts>calls"? 'r':'y')));
    if(flow.ivRank!=null) set('flowIV', 'IVR '+flow.ivRank, 'y');
    if(flow.offEx!=null) set('flowOffEx', flow.offEx+'%', (flow.offEx>45?'g':(flow.offEx<35?'r':'y')));
  }
  function renderBlindspots(b){
    if(!b) return;
    const w=document.getElementById('tileWeb'); if(w) w.textContent = b.web||'n/a';
    const j=document.getElementById('tileJobs'); if(j) j.textContent = b.jobs||'n/a';
    const a=document.getElementById('tileApp'); if(a) a.textContent = b.app||'n/a';
    const d=document.getElementById('tileDP'); if(d) d.textContent = b.darkpool||'n/a';
  }
})();

// ===== IR VERIFIER MODULE =====
(function(){
  const statusEl = document.getElementById('verifyStatus');
  const endpoint = window.LPE_IR_VERIFY_ENDPOINT;
  if(!endpoint){ statusEl.textContent = 'Not configured'; return; }
  statusEl.textContent = 'Checkingâ€¦';
  fetch(endpoint, {cache:'no-store'})
    .then(r=>r.json())
    .then(data=>{
      const events = Array.isArray(data.events) ? data.events : [];
      let updates = 0, verified = 0;
      const timeline = document.querySelectorAll('.card ul li');
      events.forEach(ev=>{
        const date = ev.date || '';
        const ticker = (ev.ticker||'').toUpperCase();
        let matched = false;
        timeline.forEach(li=>{
          const text = li.textContent || '';
          if(text.toUpperCase().includes(ticker)){
            matched = true;
            if(date && text.includes(date)){ addBadge(li, 'âœ“ Verified', '#0ea5e9'); verified++; }
            else { addBadge(li, 'âš  Update avail: '+date, '#eab308'); updates++; }
          }
        });
        if(!matched && date){
          const lanes = document.querySelector('.lanes');
          if(lanes){
            const suggestion = document.createElement('div');
            suggestion.className='note small';
            suggestion.textContent = `New event from verifier â†’ ${ticker}: ${ev.label} on ${date}${ev.session?(' ('+ev.session+')'):''}`;
            lanes.appendChild(suggestion);
            updates++;
          }
        }
      });
      statusEl.textContent = `Done â€” ${verified} verified, ${updates} update hint${updates!==1?'s':''}`;
    })
    .catch(err=>{ statusEl.textContent = 'Error fetching verifier JSON'; console.warn(err); });

  function addBadge(li, txt, color){
    const span = document.createElement('span');
    span.className='tag';
    span.textContent = txt;
    span.style.background = '#0a1a2a';
    span.style.border = '1px solid '+color;
    span.style.color = color;
    span.style.marginLeft = '8px';
    li.appendChild(span);
  }
})();
</script>
</body>
</html>
