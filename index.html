<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Living Portfolio â€” v3.4 Clean + Crypto Colors</title>
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif;font-size:16px;line-height:1.55}
.wrapper{max-width:1280px;margin:auto;padding:20px}
.header{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-bottom:16px}
.h1{font-size:22px;font-weight:700}
.sub{color:var(--muted);font-size:14px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input[type="search"]{padding:8px 12px;border-radius:10px;background:#0b1b2c;border:1px solid #1b3a5a;color:var(--text);font-size:14px;min-width:220px}
button{padding:8px 12px;border-radius:10px;background:#0b1b2c;border:1px solid #1b3a5a;color:#bfe2ff;cursor:pointer}
button:hover{filter:brightness(1.1)}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.card{background:var(--panel);border:1px solid #0b2540;border-radius:14px;padding:16px;margin-bottom:14px;flex:1 1 100%}
.h2{font-size:16px;font-weight:600;text-transform:uppercase;color:#93c5fd;margin:8px 0 12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{font-size:14px;padding:10px;border-bottom:1px solid #0b2540;vertical-align:top}
.table th{color:#a5b4fc;font-weight:600;text-align:left}
.badge{padding:4px 10px;border-radius:999px;background:#0b1b2c;border:1px solid #1b3a5a;color:#7dd3fc;font-weight:600;font-size:13px}
.tag{padding:3px 8px;border-radius:999px;font-size:12px;margin-right:4px;border:1px solid transparent}
.tag.g{background:rgba(16,185,129,.15);color:#34d399;border-color:rgba(16,185,129,.35)}
.tag.y{background:rgba(245,158,11,.15);color:#fbbf24;border-color:rgba(245,158,11,.35)}
.tag.r{background:rgba(239,68,68,.15);color:#f87171;border-color:rgba(239,68,68,.35)}
.timeline{display:grid;gap:8px;max-height:520px;overflow:auto}
.timeline .item{display:flex;gap:12px;align-items:center;background:#0b1b2c;border:1px solid #1b3a5a;border-radius:10px;padding:10px;font-size:14px}
.flag{font-size:18px}
.small{font-size:13px;color:var(--muted)}
.pill{padding:3px 10px;border-radius:999px;border:1px solid #1b3a5a;background:#0b1b2c;font-size:12px}
.pill.ok{border-color:#10b981;color:#10b981}
.pill.warn{border-color:#f59e0b;color:#f59e0b}
.pill.bad{border-color:#ef4444;color:#ef4444}
@media (min-width: 980px){
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
}
</style>
</head>
<body>
<div class="wrapper">

  <div class="header">
    <div>
      <div class="h1">âš¡ Living Portfolio Dashboard â€” v3.4</div>
      <div class="sub">
        Data as-of: <span id="dataAsOf">â€”</span> Â· Last fetch: <span id="lastFetch">â€”</span>
        Â· Status: <span id="statusPill" class="pill">Loadingâ€¦</span>
      </div>
    </div>
    <div class="controls">
      <input id="q" type="search" placeholder="Search tickerâ€¦ (e.g., NVDA)"/>
      <button id="btnRefresh">Refresh</button>
      <button id="btnForce">Force Reload</button>
    </div>
  </div>

  <div class="row" id="topKPIs">
    <div class="card"><strong>Sector exposure:</strong> <span id="kpiSectors">â€”</span></div>
    <div class="card"><strong>Spec sleeve:</strong> <span id="kpiSpec">â€”</span></div>
    <div class="card"><strong>Flow snapshot:</strong> <span id="kpiFlow">â€”</span></div>
  </div>

  <div class="grid2">
    <div class="card">
      <div class="h2">Core Portfolio</div>
      <table class="table" id="coreTable">
        <thead><tr><th>Ticker</th><th>Weight</th><th>Q</th><th>Notes</th><th>Exits</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">Swing Plays (3â€“6M)</div>
      <table class="table" id="swingTable">
        <thead><tr><th>Ticker</th><th>Weight</th><th>Signal</th><th>Notes</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">Speculative Sleeve</div>
      <table class="table" id="specTable">
        <thead><tr><th>Ticker</th><th>Weight</th><th>Signal</th><th>Notes</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <div class="card">
      <div class="h2">Crypto Sleeve</div>
      <table class="table" id="cryptoTable">
        <thead><tr><th>Symbol</th><th>Weight</th><th>Signal</th><th>Notes</th></tr></thead><tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="h2">Catalyst Timeline (Next 90 Days)</div>
    <div class="timeline" id="timeline"></div>
  </div>

</div>

<script>
const ENDPOINT='https://drealmaestro.github.io/living-portfolio/live.json';
const $=sel=>document.querySelector(sel);
const $$=sel=>Array.from(document.querySelectorAll(sel));

function asPercent(x){
  if(x==null) return 0;
  const s=String(x).trim();
  if(s.endsWith('%')) return parseFloat(s.slice(0,-1))||0;
  const n=parseFloat(s); return Number.isFinite(n)?n:0;
}
function colorTag(sig){
  if(!sig) return '';
  const s=String(sig).toLowerCase();
  if(s.includes('buy')||s.includes('inflow')||s.includes('bull')||s.includes('green')) return `<span class="tag g">${sig}</span>`;
  if(s.includes('neutral')||s.includes('watch')||s.includes('yellow')) return `<span class="tag y">${sig}</span>`;
  if(s.includes('sell')||s.includes('outflow')||s.includes('bear')||s.includes('red')) return `<span class="tag r">${sig}</span>`;
  return sig;
}
function renderTable(tbId, rows, cols, color=false){
  const tb=$(tbId+' tbody'); tb.innerHTML='';
  (rows||[]).forEach(r=>{
    tb.innerHTML+=`<tr>${cols.map(c=>{
      let v = r[c] ?? '';
      if(color && c==='signal') v = colorTag(v);
      if(c==='ticker' || c==='symbol'){ v = `<span class="badge">${v||r.symbol||''}</span>`; }
      return `<td>${v}</td>`;
    }).join('')}</tr>`;
  });
}
function renderTimeline(cats){
  const el=$('#timeline'); el.innerHTML='';
  const list=[];
  (cats?.company||[]).forEach(x=>{
    list.push({date:x.date,label:(x.ticker?x.ticker+' â€” ':'')+(x.label||''),impact:x.impact||'Med'});
  });
  (cats?.macro||[]).forEach(x=>{
    list.push({date:x.date,label:x.label,impact:x.impact||'Med'});
  });
  list.sort((a,b)=>String(a.date).localeCompare(String(b.date)));
  list.forEach(x=>{
    const flag=x.impact==='High'?'ðŸŸ¢':x.impact==='Med'?'ðŸŸ¡':'ðŸ”´';
    el.innerHTML+=`<div class="item"><span class="flag">${flag}</span><div>${x.date||''} â€” ${x.label||''}</div></div>`;
  });
}
function computeKPIs(data){
  // Sector exposure (Core)
  const sectors={};
  (data.core||[]).forEach(it=>{
    const sec=it.sector||'Other';
    sectors[sec]=(sectors[sec]||0)+asPercent(it.weight);
  });
  const top=Object.entries(sectors).sort((a,b)=>b[1]-a[1]).slice(0,4).map(([k,v])=>`${k} ${v.toFixed(0)}%`).join(' Â· ');
  $('#kpiSectors').textContent=top || 'â€”';

  // Spec sleeve %
  const specPct=(data.spec||[]).reduce((s,x)=>s+asPercent(x.weight),0);
  const pill=$('#kpiSpec');
  pill.textContent=`${specPct.toFixed(1)}%`;
  pill.className='pill '+(specPct<=5?'ok':specPct<=7?'warn':'bad');

  // Flow notes
  $('#kpiFlow').textContent=data.flow?.notes || 'â€”';

  // Simple status rule: if Tech core >30% or Spec >5% â†’ warn
  const techPct=sectors['Technology']||0;
  const status=$('#statusPill');
  const ok = (techPct<=30) && (specPct<=5);
  status.textContent = ok ? 'ðŸŸ¢ Compliant' : (specPct>5 || techPct>30 ? 'ðŸŸ¡ Review' : 'ðŸ”´ Check');
  status.className='pill '+(ok?'ok':'warn');
}
function render(data){
  // show as-of from data, separate from last fetch
  $('#dataAsOf').textContent = data.asof || 'â€”';
  renderTable('#coreTable',data.core,['ticker','weight','q','notes','exits']);
  renderTable('#swingTable',data.swing,['ticker','weight','signal','notes'],true);
  renderTable('#specTable',data.spec,['ticker','weight','signal','notes'],true);
  // crypto uses .crypto; allow either 'ticker' or 'symbol'
  const cryptoRows=(data.crypto||[]).map(x=>({symbol:x.ticker||x.symbol,weight:x.weight,signal:x.signal,notes:x.notes}));
  renderTable('#cryptoTable',cryptoRows,['symbol','weight','signal','notes'],true);
  renderTimeline(data.catalysts||{company:[],macro:[]});
  computeKPIs(data);
}
async function load(force=false){
  try{
    const t=Date.now();
    const url=ENDPOINT + (ENDPOINT.includes('?')?'&':'?') + 'cb=' + t + (force?('&force='+t):'');
    const r=await fetch(url,{cache:'no-store'});
    const j=await r.json();
    render(j);
    $('#lastFetch').textContent=new Date().toISOString().slice(0,16).replace('T',' ');
  }catch(e){
    console.error(e);
    const status=$('#statusPill');
    status.textContent='ðŸ”´ Fetch failed';
    status.className='pill bad';
  }
}
// Search filter (tables + timeline)
$('#q').addEventListener('input',e=>{
  const q=e.target.value.toUpperCase();
  $$('table tbody tr,#timeline .item').forEach(el=>{
    el.style.display=el.textContent.toUpperCase().includes(q)?'':'none';
  });
});
// Buttons
$('#btnRefresh').addEventListener('click',()=>load(false));
$('#btnForce').addEventListener('click',()=>load(true));

// Init
load(true); setInterval(()=>load(false),180000);
</script>
</body>
</html>